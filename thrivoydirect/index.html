<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Thrivoy Onboarding</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;padding:20px;max-width:760px;margin:0 auto}
    h1{color:#1166EE}
    label{display:block;margin-top:10px;font-weight:600}
    input,select,textarea{width:100%;padding:8px;margin-top:6px;border:1px solid #ddd;border-radius:4px}
    .inline{display:flex;gap:8px}
    .small{width:48%}
    .btn{background:#1166EE;color:#fff;padding:10px 12px;border:none;border-radius:6px;margin-top:12px;cursor:pointer}
    .btn:disabled{background:#ccc;cursor:not-allowed}
    .note{color:#666;font-size:13px}
    .result{margin-top:20px;padding:15px;border:1px solid #ddd;border-radius:6px;display:none}
    .success{border-color:#28a745;background-color:#d4edda}
    .error{border-color:#dc3545;background-color:#f8d7da}
    .loading{border-color:#007bff;background-color:#d1ecf1}
    .debug{margin-top:10px;padding:10px;background:#f8f9fa;border:1px solid #dee2e6;border-radius:4px;font-family:monospace;font-size:12px;max-height:200px;overflow-y:auto}
  </style>
</head>
<body>
  <h1>Get your Thrivoy site live</h1>
  <p class="note">Enter business details. Setup fee waived for Founders — ₹499/month thereafter. You can pay by UPI or be billed.</p>
  
  <form id="onboardForm" method="post" action="https://script.google.com/macros/s/AKfycbwV8qUBA62C27x-xn4Z5Oij6ckMFgn3JIKCelof3HE9PbsDyT6LAhTqO4jPBFdlcl2aog/exec">
    <input type="hidden" name="action" value="onboard"/>
    <label>Business name <input name="businessName" required /></label>
    <label>Owner name <input name="ownerName" required /></label>
    <label>Email <input name="email" type="email" required /></label>
    <label>Phone (include country code) <input name="phone" placeholder="919876543210" required /></label>
    <label>Category <input name="category" required /></label>
    <label>Location <input name="location" required /></label>
    <label>Description <textarea name="description"></textarea></label>
    
    <h3>Branding & Marketing</h3>
    <label>Tagline <input name="tagline" /></label>
    <label>Brand primary (hex) <input name="brandPrimary" placeholder="#1166EE" /></label>
    <label>Brand secondary (hex) <input name="brandSecondary" placeholder="#FF8800" /></label>
    <label>Platforms (comma separated) <input name="platforms" value="linkedin,facebook,instagram,whatsapp" /></label>
    <label>Frequency <select name="frequency"><option value="weekly">Weekly</option><option value="daily">Daily</option><option value="monthly">Monthly</option></select></label>
    <label>Tone <select name="tone"><option value="friendly">Friendly</option><option value="professional">Professional</option></select></label>
    
    <h3>WhatsApp & Payment</h3>
    <label>WhatsApp number (for site) <input name="whatsappNumber" placeholder="919876543210" /></label>
    <label><input type="checkbox" name="showWhatsApp" value="true" checked /> Display WhatsApp on my website</label>
    
    <h3>Billing</h3>
    <div class="inline">
      <div class="small"><label>Plan: <input name="plan" value="starter" readonly /></label></div>
      <div class="small"><label>Price: <input name="price" value="499" readonly /></label></div>
    </div>
    <p class="note">You will receive a UPI payment link after onboarding if you choose to pay now. Admin can verify payments manually.</p>
    
    <button class="btn" type="submit" id="submitBtn">Create my site</button>
  </form>

  <!-- Result display area -->
  <div id="result" class="result">
    <div id="resultContent"></div>
  </div>

  <!-- Debug area (remove in production) -->
  <div id="debugArea" style="margin-top:20px;">
    <h4>Debug Info:</h4>
    <div id="debugLog" class="debug"></div>
    <button type="button" onclick="clearDebugLog()">Clear Log</button>
  </div>

  <script>
    var debugLog = document.getElementById('debugLog');
    var resultDiv = document.getElementById('result');
    var resultContent = document.getElementById('resultContent');
    var submitBtn = document.getElementById('submitBtn');

    function addDebugLog(message) {
      var timestamp = new Date().toLocaleTimeString();
      debugLog.innerHTML += '<div>[' + timestamp + '] ' + message + '</div>';
      debugLog.scrollTop = debugLog.scrollHeight;
      console.log('[Thrivoy Debug]', message);
    }

    function clearDebugLog() {
      debugLog.innerHTML = '';
    }

    function showResult(type, title, content) {
      resultDiv.className = 'result ' + type;
      resultDiv.style.display = 'block';
      resultContent.innerHTML = '<h3>' + title + '</h3>' + content;
      resultDiv.scrollIntoView({ behavior: 'smooth' });
    }

    // Listen for postMessage responses
    window.addEventListener('message', function(ev) {
      addDebugLog('Received postMessage from origin: ' + ev.origin);
      addDebugLog('Message data: ' + JSON.stringify(ev.data));
      
      try {
        var data = ev.data;
        if (!data) {
          addDebugLog('No data in message, ignoring');
          return;
        }
        
        if (typeof data === 'object' && ('success' in data || 'action' in data)) {
          addDebugLog('Processing Thrivoy response: success=' + data.success);
          
          if (data.success) {
            var successContent = '<p><strong>Business ID:</strong> ' + (data.businessId || 'created') + '</p>';
            if (data.websiteUrl) {
              successContent += '<p><strong>Website:</strong> <a href="' + data.websiteUrl + '" target="_blank">' + data.websiteUrl + '</a></p>';
              successContent += '<button onclick="window.open(\'' + data.websiteUrl + '\', \'_blank\')" class="btn">View My Website</button>';
            }
            if (data.message) {
              successContent += '<p><strong>Status:</strong> ' + data.message + '</p>';
            }
            
            showResult('success', 'Success! Your site is being created', successContent);
            alert("Success! Your business ID: " + (data.businessId || 'created'));
            
          } else {
            var errorContent = '<p>' + (data.error || 'Unknown error occurred') + '</p>';
            showResult('error', 'Error occurred', errorContent);
            alert("Error: " + (data.error || 'unknown'));
          }
          
          // Re-enable submit button
          submitBtn.disabled = false;
          submitBtn.textContent = 'Create my site';
        } else {
          addDebugLog('Ignoring non-Thrivoy message');
        }
      } catch(e) { 
        addDebugLog('Error processing message: ' + e.toString());
        submitBtn.disabled = false;
        submitBtn.textContent = 'Create my site';
      }
    }, false);

    // Custom form submission using iframe
    document.getElementById('onboardForm').addEventListener('submit', function(e) {
      e.preventDefault(); // Prevent normal form submission
      
      addDebugLog('Form submitted, creating iframe...');
      
      // Show loading state
      showResult('loading', 'Creating your site...', '<p>Please wait while we set up your business website and automation.</p>');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Creating...';
      
      // Create form data
      var formData = new FormData(this);
      var params = new URLSearchParams(formData).toString();
      
      addDebugLog('Form data: ' + params);
      
      // Create hidden iframe for submission
      var iframe = document.createElement('iframe');
      iframe.style.display = 'none';
      iframe.name = 'thrivoyFrame';
      document.body.appendChild(iframe);
      
      // Create a temporary form that targets the iframe
      var tempForm = document.createElement('form');
      tempForm.method = 'POST';
      tempForm.action = this.getAttribute('action');
      tempForm.target = 'thrivoyFrame';
      tempForm.style.display = 'none';
      
      // Copy all form data to temp form
      for (var pair of formData.entries()) {
        var input = document.createElement('input');
        input.type = 'hidden';
        input.name = pair[0];
        input.value = pair[1];
        tempForm.appendChild(input);
      }
      
      document.body.appendChild(tempForm);
      addDebugLog('Submitting via iframe...');
      tempForm.submit();
      
      // Cleanup
      setTimeout(function() {
        if (tempForm.parentNode) tempForm.parentNode.removeChild(tempForm);
        if (iframe.parentNode) iframe.parentNode.removeChild(iframe);
      }, 1000);
      
      // Timeout fallback
      setTimeout(function() {
        if (submitBtn.disabled) {
          addDebugLog('Timeout: No response received after 30 seconds');
          showResult('error', 'Timeout', '<p>No response received. Please try again.</p>');
          submitBtn.disabled = false;
          submitBtn.textContent = 'Create my site';
        }
      }, 30000);
    });

    // Initial debug info
    addDebugLog('Page loaded, ready for form submission...');
</script>
</body>
</html>
