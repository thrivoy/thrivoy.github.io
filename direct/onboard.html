<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Thrivoy Onboarding</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="styles.css"> <!-- optional -->
  <script src="config.js"></script> <!-- must exist and define APPS_SCRIPT_URL -->
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f4f6f9;padding:20px}
    .card{max-width:760px;margin:20px auto;background:#fff;padding:22px;border-radius:8px;box-shadow:0 4px 18px rgba(0,0,0,0.06)}
    h1{margin:0 0 12px;color:#1e293b}
    label{display:block;margin-top:10px;font-weight:600}
    input[type=text], input[type=email], textarea, select {width:100%;padding:8px;margin-top:6px;border:1px solid #d1d5db;border-radius:6px}
    .inline{display:flex;gap:10px}
    .muted{color:#6b7280;font-size:13px}
    button{background:#0b74de;color:#fff;padding:10px 16px;border-radius:6px;border:0;cursor:pointer;margin-top:14px}
    .status{margin-top:10px}
    .error{color:#b91c1c}
    .success{color:#065f46}
  </style>
</head>
<body>
  <div class="card">
    <h1>Onboard your business</h1>
    <p class="muted">Fill the fields below — the AI will use the intelligence answers to generate compelling website + content.</p>

    <form id="onboardForm" data-type="onboarding">
      <label>Business Name
        <input name="businessName" required />
      </label>

      <label>Owner Name
        <input name="ownerName" />
      </label>

      <label>Email
        <input type="email" name="email" required />
      </label>

      <label>Phone
        <input name="phone" />
      </label>

      <label>Category / Industry
        <select name="category">
          <option value="services">Services</option>
          <option value="technology">Technology</option>
          <option value="healthcare">Healthcare</option>
          <option value="education">Education</option>
          <option value="consulting">Consulting</option>
          <option value="insurance">Insurance</option>
        </select>
      </label>

      <label>Location (City, State)
        <input name="location" placeholder="e.g., Bangalore, India" />
      </label>

      <hr style="margin:14px 0"/>

      <h3>Intelligence questions (these matter — Gemini uses them)</h3>

      <label>Short description (what you do)
        <textarea name="description" rows="3" placeholder="What does your business do?"></textarea>
      </label>

      <label>Target audience
        <input name="targetAudience" placeholder="Who are your customers?" />
      </label>

      <label>Unique value / USP
        <input name="uniqueValue" placeholder="What makes you different?" />
      </label>

      <label>Key benefits (comma separated)
        <input name="keyBenefits" placeholder="What benefits do customers get? e.g., faster delivery, lower cost" />
      </label>

      <label>Problem you solve
        <input name="problemSolved" placeholder="Which customer problem do you solve?" />
      </label>

      <label>Tone (professional, friendly, bold...)
        <input name="tone" placeholder="e.g., friendly" />
      </label>

      <div style="margin-top:12px">
        <button id="submitBtn" type="submit">Create my website</button>
        <span class="status" id="statusText"></span>
      </div>
    </form>
  </div>

  <script>
    // Basic JSONP helper
    function makeJSONPRequest(url, params, callbackName, onComplete, timeoutMs=15000) {
      // build unique callback parameter name if not provided
      const cb = callbackName || ('cb_' + Date.now() + '_' + Math.random().toString(36).slice(2,8));
      params = Object.assign({}, params, { callback: cb });

      const query = Object.keys(params).map(k => encodeURIComponent(k) + '=' + encodeURIComponent(params[k])).join('&');
      const script = document.createElement('script');
      script.src = url + (url.indexOf('?') === -1 ? '?' : '&') + query;
      script.async = true;
      let timer = setTimeout(() => {
        cleanup();
        onComplete({ success: false, error: 'JSONP timeout' });
      }, timeoutMs);

      window[cb] = function(data){
        clearTimeout(timer);
        cleanup();
        onComplete(data);
      };

      script.onerror = function(){
        clearTimeout(timer);
        cleanup();
        onComplete({ success: false, error: 'JSONP script load failed' });
      };

      function cleanup(){
        try { if (script.parentNode) script.parentNode.removeChild(script); } catch(e){}
        try { delete window[cb]; } catch(e){}
      }

      document.head.appendChild(script);
    }

    (function(){
      const form = document.getElementById('onboardForm');
      const status = document.getElementById('statusText');
      const submitBtn = document.getElementById('submitBtn');

      function setStatus(txt, cls) {
        status.textContent = txt || '';
        status.className = 'status ' + (cls || '');
      }

      form.addEventListener('submit', function(ev){
        ev.preventDefault();
        setStatus('Preparing submission...', '');
        submitBtn.disabled = true;

        const fd = new FormData(form);
        const data = {};
        for (const [k,v] of fd.entries()) {
          data[k] = v;
        }
        // add action
        data.action = 'onboard';

        // Validate minimal fields
        if (!data.businessName || !data.email) {
          setStatus('Business name and email are required', 'error');
          submitBtn.disabled = false;
          return;
        }

        setStatus('Submitting (JSONP) — this bypasses CORS...', '');

        // Use JSONP GET — backend supports onboard via GET with JSONP
        try {
          makeJSONPRequest(APPS_SCRIPT_URL, data, null, function(resp){
            if (!resp) {
              setStatus('No response from server', 'error');
              submitBtn.disabled = false;
              return;
            }
            if (resp.success) {
              setStatus('Success! Redirecting...', 'success');

              // Redirect to thank you with businessId, pass remember=true by default
              const biz = resp.businessId || resp.businessID || resp.id || resp.id0 || resp.id1 || resp.business_id || resp.biz || '';
              if (biz) {
                // redirect with remember flag set so thankyou auto-saves
                window.location.href = 'thankyou.html?businessId=' + encodeURIComponent(biz) + '&remember=true';
                return;
              } else {
                // if server didn't return id, show message
                setStatus('Onboarded but no businessId returned. Please check dashboard later.', 'error');
                submitBtn.disabled = false;
                return;
              }
            } else {
              setStatus('Submission failed: ' + (resp.error || resp.message || 'unknown'), 'error');
              submitBtn.disabled = false;
            }
          }, 20000);
        } catch (err) {
          setStatus('Submission error: ' + err.message, 'error');
          submitBtn.disabled = false;
        }
      });
    })();
  </script>
</body>
</html>
