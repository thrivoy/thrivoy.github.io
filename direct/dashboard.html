<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Thrivoy Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="config.js"></script>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f7fafc;padding:18px}
    .wrap{max-width:980px;margin:18px auto}
    .card{background:#fff;padding:18px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.05);margin-bottom:14px}
    .muted{color:#6b7280}
    .tagline{font-size:20px;color:#0b74de;margin:6px 0}
    .hero{font-size:16px;margin:6px 0;color:#111827}
    .content-plan{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:10px;margin-top:12px}
    .plan-item{background:#f8fafc;padding:10px;border-radius:6px}
    button{background:#0b74de;color:#fff;padding:8px;border-radius:6px;border:0;cursor:pointer}
    .controls{display:flex;gap:10px;align-items:center}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <h2 id="bizName">Loading business...</h2>
          <div id="bizIdDisplay" class="muted"></div>
        </div>
        <div class="controls">
          <button id="refreshBtn">Refresh</button>
          <button id="forgetBtn" style="background:#ef4444">Forget Business</button>
        </div>
      </div>

      <div id="contentArea" style="margin-top:14px">
        <div class="muted">Fetching AI content...</div>
      </div>
    </div>

    <div id="planCard" class="card">
      <h3>7-day Content Plan</h3>
      <div id="plan" class="content-plan"></div>
    </div>
  </div>

  <script>
    // JSONP helper (same as onboard)
    function makeJSONPRequest(url, params, callbackName, onComplete, timeoutMs=12000) {
      const cb = callbackName || ('cb_' + Date.now() + '_' + Math.random().toString(36).slice(2,8));
      params = Object.assign({}, params, { callback: cb });
      const query = Object.keys(params).map(k => encodeURIComponent(k) + '=' + encodeURIComponent(params[k])).join('&');
      const script = document.createElement('script');
      script.src = url + (url.indexOf('?') === -1 ? '?' : '&') + query;
      script.async = true;
      let timer = setTimeout(()=>{ cleanup(); onComplete({ success:false, error:'timeout' }); }, timeoutMs);
      window[cb] = function(data){ clearTimeout(timer); cleanup(); onComplete(data); };
      script.onerror = function(){ clearTimeout(timer); cleanup(); onComplete({ success:false, error:'load error' }); };
      function cleanup(){ try{ document.head.removeChild(script); }catch(e){} try{ delete window[cb]; }catch(e){} }
      document.head.appendChild(script);
    }

    (function(){
      const params = new URLSearchParams(location.search);
      let bizId = params.get('businessId') || '';
      // fallback to localStorage
      try { if (!bizId) bizId = localStorage.getItem('thrivoyBizId') || ''; } catch(e) {}

      const bizNameEl = document.getElementById('bizName');
      const bizIdEl = document.getElementById('bizIdDisplay');
      const contentArea = document.getElementById('contentArea');
      const planEl = document.getElementById('plan');
      const refreshBtn = document.getElementById('refreshBtn');
      const forgetBtn = document.getElementById('forgetBtn');

      function showError(msg) { contentArea.innerHTML = '<div class="muted" style="color:#b91c1c">'+msg+'</div>'; }

      if (!bizId) {
        bizNameEl.textContent = 'No Business selected';
        bizIdEl.textContent = '';
        contentArea.innerHTML = '<div class="muted">Please enter your Business ID or use the onboarding flow.</div>';
        return;
      }

      bizIdEl.textContent = 'Business ID: ' + bizId;

      function loadDashboard(){
        contentArea.innerHTML = '<div class="muted">Loading content & taglines...</div>';
        // 1) fetch ThankYou / business object to get saved fields
        makeJSONPRequest(APPS_SCRIPT_URL, { action: 'getThankYou', businessId: bizId }, null, function(resp){
          if (!resp || !resp.success) {
            showError('Failed to load business data: ' + (resp && resp.error || 'unknown'));
            return;
          }
          const biz = resp.business || {};
          bizNameEl.textContent = biz.businessName || biz.businessname || 'Your Business';
          // show tagline/hero if available
          const tagline = biz.tagline || biz.Tagline || resp.tagline || '';
          const hero = biz.hero || biz.heroMessage || resp.heroMessage || '';
          const html = `
            ${tagline ? '<div class="tagline">'+tagline+'</div>' : ''}
            ${hero ? '<div class="hero">'+hero+'</div>' : ''}
            <p class="muted">Category: ${biz.category || biz.Category || '-'} | Location: ${biz.location || biz.Location || '-'}</p>
          `;
          contentArea.innerHTML = html;
        }, 12000);

        // 2) request a 7-day content plan (uses generateContentPlan endpoint)
        makeJSONPRequest(APPS_SCRIPT_URL, { action: 'generateContentPlan', businessName: '', businessId: bizId }, null, function(resp){
          planEl.innerHTML = '';
          if (!resp || !resp.success) {
            planEl.innerHTML = '<div class="muted">Unable to create content plan: ' + (resp && resp.error || 'unknown') + '</div>';
            return;
          }
          const plan = resp.plan || [];
          if (plan.length === 0) {
            planEl.innerHTML = '<div class="muted">No plan items returned</div>';
            return;
          }
          plan.forEach(function(item){
            const card = document.createElement('div');
            card.className = 'plan-item';
            card.innerHTML = '<strong>Day '+item.day+'</strong><div style="margin-top:6px;font-weight:600">'+ (item.title || '') + '</div><div style="margin-top:6px">'+ (item.text || '') + '</div><div style="margin-top:8px;color:#6b7280">'+(item.hashtags || '')+'</div>';
            planEl.appendChild(card);
          });
        }, 14000);
      }

      refreshBtn.addEventListener('click', loadDashboard);
      forgetBtn.addEventListener('click', function(){
        try { localStorage.removeItem('thrivoyBizId'); } catch(e){}
        alert('Business ID forgotten. You will need to re-enter Business ID to access dashboard.');
        location.href = 'onboard.html';
      });

      // initial load
      loadDashboard();
    })();
  </script>
</body>
</html>
