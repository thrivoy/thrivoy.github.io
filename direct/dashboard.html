<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Thrivoy Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="config.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0; padding: 0;
      background: #f5f7fa;
      color: #333;
    }
    header {
      background: #4a90e2;
      color: #fff;
      padding: 1rem;
      text-align: center;
    }
    main {
      max-width: 900px;
      margin: 2rem auto;
      background: #fff;
      padding: 2rem;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    h1, h2 {
      margin-top: 0;
    }
    section {
      margin-bottom: 2rem;
    }
    button {
      padding: 0.6rem 1rem;
      border: none;
      border-radius: 6px;
      background: #4a90e2;
      color: #fff;
      cursor: pointer;
      font-size: 1rem;
    }
    button:disabled {
      background: #aaa;
      cursor: not-allowed;
    }
    ul, ol {
      margin: 0;
      padding-left: 1.2rem;
    }
    li {
      margin: 0.25rem 0;
    }
    .card {
      padding: 1rem;
      border: 1px solid #eee;
      border-radius: 6px;
      background: #fafafa;
      margin-bottom: 1rem;
    }
    input {
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1rem;
      width: 100%;
    }
  </style>
</head>
<body>
  <header>
    <h1>Thrivoy Business Dashboard</h1>
  </header>
  <main>
    <section>
      <h2>Find Your Dashboard</h2>
      <input type="text" id="bizIdInput" placeholder="Enter your Business ID (e.g., BIZ-12345)">
      <button id="loadBtn">Load Dashboard</button>
    </section>

    <section id="bizInfo" style="display:none;">
      <h2>Business Info</h2>
      <div class="card" id="bizDetails"></div>
    </section>

    <section id="taglines" style="display:none;">
      <h2>Taglines</h2>
      <ul id="taglineList"></ul>
      <button id="regenTaglines">Regenerate Taglines</button>
    </section>

    <section id="contentPlanSec" style="display:none;">
      <h2>7-Day Content Plan</h2>
      <ol id="contentPlan"></ol>
      <button id="regenPlan">Regenerate Content Plan</button>
    </section>
  </main>

  <script>
    // JSONP helper
    function makeJSONPRequest(url, params, callback) {
      const callbackName = 'jsonp_cb_' + Math.round(100000 * Math.random());
      params = params || {};
      params.callback = callbackName;

      const query = Object.keys(params)
        .map(k => encodeURIComponent(k) + '=' + encodeURIComponent(params[k]))
        .join('&');

      const script = document.createElement('script');
      script.src = url + '?' + query;

      window[callbackName] = function(data) {
        callback(data);
        document.head.removeChild(script);
        delete window[callbackName];
      };

      document.head.appendChild(script);
    }

    const loadBtn = document.getElementById('loadBtn');
    const bizIdInput = document.getElementById('bizIdInput');
    const bizInfoSec = document.getElementById('bizInfo');
    const bizDetails = document.getElementById('bizDetails');
    const taglineSec = document.getElementById('taglines');
    const taglineList = document.getElementById('taglineList');
    const regenTaglines = document.getElementById('regenTaglines');
    const contentSec = document.getElementById('contentPlanSec');
    const contentPlan = document.getElementById('contentPlan');
    const regenPlan = document.getElementById('regenPlan');

    let currentBiz = null;

    // Load dashboard
    loadBtn.addEventListener('click', function() {
      const bizId = bizIdInput.value.trim();
      if (!bizId) {
        alert('Please enter your Business ID.');
        return;
      }

      makeJSONPRequest(APPS_SCRIPT_URL, { action: 'getDashboard', businessId: bizId }, function(res) {
        console.log('Dashboard:', res);

        if (!res.success) {
          alert('❌ Could not load dashboard: ' + (res.error || 'Unknown error'));
          return;
        }

        currentBiz = res;
        renderDashboard(res);
      });
    });

    function renderDashboard(data) {
      // Business Info
      bizInfoSec.style.display = 'block';
      bizDetails.innerHTML = `
        <strong>Name:</strong> ${data.businessName || ''}<br>
        <strong>Owner:</strong> ${data.ownerName || ''}<br>
        <strong>Email:</strong> ${data.email || ''}<br>
        <strong>Phone:</strong> ${data.phone || ''}<br>
        <strong>Category:</strong> ${data.category || ''}<br>
        <strong>Description:</strong> ${data.descr || ''}
      `;

      // Taglines
      taglineSec.style.display = 'block';
      taglineList.innerHTML = '';
      if (data.taglines && data.taglines.length > 0) {
        data.taglines.forEach(t => {
          const li = document.createElement('li');
          li.textContent = t;
          taglineList.appendChild(li);
        });
      } else {
        taglineList.innerHTML = '<li>No taglines yet.</li>';
      }

      // Content plan
      contentSec.style.display = 'block';
      contentPlan.innerHTML = '';
      if (data.contentPlan && data.contentPlan.length > 0) {
        data.contentPlan.forEach(p => {
          const li = document.createElement('li');
          li.textContent = (p.platform ? '[' + p.platform + '] ' : '') + (p.title || '') + ': ' + (p.text || '');
          contentPlan.appendChild(li);
        });
      } else {
        contentPlan.innerHTML = '<li>No content plan yet.</li>';
      }
    }

    // Regenerate taglines
    regenTaglines.addEventListener('click', function() {
      if (!currentBiz) return;
      regenTaglines.disabled = true;
      regenTaglines.textContent = 'Regenerating...';

      makeJSONPRequest(APPS_SCRIPT_URL, {
        action: 'generateTagline',
        businessName: currentBiz.businessName,
        service: currentBiz.descr,
        targetCustomer: currentBiz.targetCustomer,
        usp: currentBiz.usp
      }, function(res) {
        regenTaglines.disabled = false;
        regenTaglines.textContent = 'Regenerate Taglines';

        taglineList.innerHTML = '';
        if (res.success && res.taglines) {
          res.taglines.forEach(t => {
            const li = document.createElement('li');
            li.textContent = t;
            taglineList.appendChild(li);
          });
        } else {
          taglineList.innerHTML = '<li>❌ Could not regenerate taglines.</li>';
        }
      });
    });

    // Regenerate content plan
    regenPlan.addEventListener('click', function() {
      if (!currentBiz) return;
      regenPlan.disabled = true;
      regenPlan.textContent = 'Regenerating...';

      makeJSONPRequest(APPS_SCRIPT_URL, {
        action: 'generateContentPlan',
        businessName: currentBiz.businessName,
        service: currentBiz.descr,
        targetCustomer: currentBiz.targetCustomer,
        usp: currentBiz.usp
      }, function(res) {
        regenPlan.disabled = false;
        regenPlan.textContent = 'Regenerate Content Plan';

        contentPlan.innerHTML = '';
        if (res.success && res.plan) {
          res.plan.forEach(p => {
            const li = document.createElement('li');
            li.textContent = (p.platform ? '[' + p.platform + '] ' : '') + (p.title || '') + ': ' + (p.text || '');
            contentPlan.appendChild(li);
          });
        } else {
          contentPlan.innerHTML = '<li>❌ Could not regenerate content plan.</li>';
        }
      });
    });
  </script>
</body>
</html>
