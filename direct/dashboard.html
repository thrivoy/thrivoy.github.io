<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dashboard - Thrivoy</title>
  <script src="config.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h2 { text-align: center; }
    table { border-collapse: collapse; margin: 20px auto; width: 80%; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #f0f0f0; }
    .badge { padding: 4px 8px; border-radius: 6px; color: white; }
    .active { background: green; }
    .pending { background: orange; }
  </style>
</head>
<body>
  <h2>üìä Business Dashboard</h2>
  <div id="dashboard">Loading...</div>

  <script>
    function makeJSONPRequest(url, params, callback) {
      const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
      params.callback = callbackName;
      const queryString = Object.keys(params).map(k => encodeURIComponent(k) + '=' + encodeURIComponent(params[k])).join('&');
      const script = document.createElement('script');
      script.src = url + '?' + queryString;
      window[callbackName] = function(data) {
        callback(data);
        document.head.removeChild(script);
        delete window[callbackName];
      };
      document.head.appendChild(script);
    }

    const urlParams = new URLSearchParams(window.location.search);
    const businessId = urlParams.get("businessId");

    if (businessId) {
      makeJSONPRequest(APPS_SCRIPT_URL, { action: "getDashboard", businessId }, function(response) {
        if (response.success) {
          let html = `<h3>Welcome, ${response.ownerName}</h3>
                      <p>Business: <strong>${response.businessName}</strong></p>
                      <h4>Invoices</h4>
                      <table>
                        <tr><th>ID</th><th>Amount</th><th>Status</th></tr>`;
          (response.invoices || []).forEach(inv => {
            const statusClass = inv.status === "Paid" ? "active" : "pending";
            html += `<tr>
                      <td>${inv.id}</td>
                      <td>‚Çπ${inv.amount}</td>
                      <td><span class="badge ${statusClass}">${inv.status}</span></td>
                    </tr>`;
          });
          html += "</table>";
          document.getElementById('dashboard').innerHTML = html;

          // Log success
          makeJSONPRequest(APPS_SCRIPT_URL, {
            action: "log",
            event: "dashboard_view",
            businessId: businessId,
            formType: "dashboard"
          }, ()=>{});
        } else {
          document.getElementById('dashboard').innerHTML = "‚ùå Error: " + (response.error || "Unable to fetch dashboard");
        }
      });
    } else {
      document.getElementById('dashboard').innerHTML = "‚ùå Missing businessId.";
    }
  </script>
</body>
</html>
